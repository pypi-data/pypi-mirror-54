<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>gridmeld Administrator's Guide</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="gridmeld-administrator-s-guide">
<h1 class="title">gridmeld Administrator's Guide</h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id5">Overview</a></li>
<li><a class="reference internal" href="#gridmeld" id="id6">gridmeld</a><ul>
<li><a class="reference internal" href="#install-gridmeld" id="id7">Install gridmeld</a></li>
<li><a class="reference internal" href="#gridmeld-command-line-programs" id="id8">gridmeld Command Line Programs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cisco-ise-pxgrid" id="id9">Cisco ISE pxGrid</a><ul>
<li><a class="reference internal" href="#export-the-ise-certificate-services-root-ca" id="id10">Export the ISE Certificate Services Root CA</a></li>
<li><a class="reference internal" href="#using-pxgrid-client-certificate-authentication" id="id11">Using pxGrid Client Certificate Authentication</a><ul>
<li><a class="reference internal" href="#example-certificate-account-creation" id="id12">Example: Certificate Account Creation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-pxgrid-username-password-authentication" id="id13">Using pxGrid Username/Password Authentication</a><ul>
<li><a class="reference internal" href="#example-username-password-account-creation" id="id14">Example: Username/Password Account Creation</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#palo-alto-networks-minemeld" id="id15">Palo Alto Networks MineMeld</a><ul>
<li><a class="reference internal" href="#install-minemeld" id="id16">Install MineMeld</a></li>
<li><a class="reference internal" href="#minemeld-nodes-configuration" id="id17">MineMeld Nodes Configuration</a><ul>
<li><a class="reference internal" href="#stdlib-localdb-miner" id="id18"><tt class="docutils literal">stdlib.localDB</tt> Miner</a></li>
<li><a class="reference internal" href="#dagpusherng-output-node" id="id19"><tt class="docutils literal">dagPusherNg</tt> Output Node</a></li>
<li><a class="reference internal" href="#dagpusher-implementations" id="id20"><tt class="docutils literal">dagPusher</tt> Implementations</a></li>
<li><a class="reference internal" href="#nodes-configuration" id="id21">Nodes Configuration</a></li>
<li><a class="reference internal" href="#stdlib-dagpusherng-sgt-node-configuration" id="id22"><tt class="docutils literal"><span class="pre">stdlib_dagPusherNg-sgt</span></tt> Node Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#minemeld-config-api" id="id23">MineMeld Config API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-the-gridmeld-gateway-application" id="id24">Running the <tt class="docutils literal">gridmeld</tt> Gateway Application</a><ul>
<li><a class="reference internal" href="#minemeld-and-pxgrid-json-options" id="id25">MineMeld and pxGrid JSON Options</a></li>
<li><a class="reference internal" href="#minemeld-session-processing-policy" id="id26">MineMeld Session Processing Policy</a><ul>
<li><a class="reference internal" href="#session-policy-examples" id="id27">Session Policy Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gate-py-example" id="id28"><tt class="docutils literal">gate.py</tt> Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ubuntu-18-04-configuration" id="id29">Ubuntu 18.04 Configuration</a><ul>
<li><a class="reference internal" href="#rsyslogd" id="id30">rsyslogd</a></li>
<li><a class="reference internal" href="#logrotate" id="id31">logrotate</a></li>
<li><a class="reference internal" href="#systemd" id="id32">systemd</a><ul>
<li><a class="reference internal" href="#access-control" id="id33">Access Control</a></li>
<li><a class="reference internal" href="#create-gridmeld-user-and-group" id="id34">Create <tt class="docutils literal">gridmeld</tt> user and group</a></li>
<li><a class="reference internal" href="#create-opt-gridmeld-for-config" id="id35">Create <tt class="docutils literal">/opt/gridmeld</tt> for Config</a></li>
<li><a class="reference internal" href="#sample-json-config-files" id="id36">Sample JSON Config Files</a></li>
<li><a class="reference internal" href="#install-json-config-files" id="id37">Install JSON Config Files</a></li>
<li><a class="reference internal" href="#install-ssl-certificates-and-private-keys" id="id38">Install SSL Certificates and Private Keys</a></li>
<li><a class="reference internal" href="#set-file-owner-and-mode" id="id39">Set File Owner and Mode</a></li>
<li><a class="reference internal" href="#configure-systemd-gridmeld-service-unit-file" id="id40">Configure systemd gridmeld Service Unit File</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#references" id="id41">References</a></li>
</ul>
</div>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#id5">Overview</a></h1>
<p><tt class="docutils literal">gridmeld</tt> is a
<a class="reference external" href="https://www.cisco.com/c/en/us/products/security/identity-services-engine/index.html">Cisco ISE</a>
pxGrid to Palo Alto Networks
<a class="reference external" href="https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/minemeld">MineMeld</a>
gateway application.</p>
<p>MineMeld is an extensible Threat Intelligence processing framework and
the <em>multi-tool</em> of threat indicator feeds.</p>
<p>Cisco ISE 2.4 provides
<a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#!introduction-to-pxgrid-2-0">REST and WebSocket APIs</a>
for pxGrid.
<a class="reference external" href="https://github.com/cisco-pxgrid/pxgrid-rest-ws/tree/master/python">Sample Python programs</a>
are provided which use the APIs,
and
<a class="reference external" href="https://github.com/cisco-pxgrid/pxgrid-rest-ws/wiki">API documentation</a>
is provided in a GitHub Wiki.</p>
<p><tt class="docutils literal">gridmeld</tt> is a Python3 application which uses these APIs to consume
session data from the ISE pxGrid service, and publish IP indicators to
MineMeld for consumption by PAN-OS.  Sessions containing a TrustSec
Security Group Tag (SGT) can be pushed by MineMeld to PAN-OS as
<tt class="docutils literal"><span class="pre">registered-ip</span></tt> objects representing an IP-SGT mapping. The objects
can then be used to configure Dynamic Address Groups (DAGs) for
security policy enforcement.  PAN-OS 9.0 has been enhanced to update
DAGs immediately, compared to a delay of up to 60 seconds in previous
versions, and <tt class="docutils literal"><span class="pre">registed-ip</span></tt> object capacity has been increased.</p>
<p><tt class="docutils literal">gridmeld</tt> is non-blocking (using
<a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a>)
and consuming session directory updates over WebSocket results
in near real-time correlation of ISE IP-SGT to PAN-OS security
policy.</p>
</div>
<div class="section" id="gridmeld">
<h1><a class="toc-backref" href="#id6">gridmeld</a></h1>
<div class="section" id="install-gridmeld">
<h2><a class="toc-backref" href="#id7">Install gridmeld</a></h2>
<p>The <tt class="docutils literal">gridmeld</tt> source repository is hosted on GitHub at
<a class="reference external" href="https://github.com/PaloAltoNetworks/gridmeld">https://github.com/PaloAltoNetworks/gridmeld</a>.
It is available as a
<a class="reference external" href="https://github.com/PaloAltoNetworks/gridmeld/releases">release</a>
on GitHub and as a
<a class="reference external" href="https://pypi.org/project/gridmeld/">package</a>
on PyPi for installing with
<a class="reference external" href="https://pip.pypa.io/en/stable/installing/">pip</a>.</p>
<p><tt class="docutils literal">gridmeld</tt> should run on any Unix system with Python 3.6 or 3.7, and
has been tested on OpenBSD 6.5 and Ubuntu 18.04.  Its module
dependencies are <tt class="docutils literal">aiohttp</tt> and <tt class="docutils literal">tenacity</tt>.</p>
</div>
<div class="section" id="gridmeld-command-line-programs">
<h2><a class="toc-backref" href="#id8">gridmeld Command Line Programs</a></h2>
<p><tt class="docutils literal">gridmeld</tt> provides 3 command line programs:</p>
<ul>
<li><p class="first"><tt class="docutils literal">grid.py</tt></p>
<p>Command line client to the pxGrid API requests used by <tt class="docutils literal">gridmeld</tt>.
This can be used for testing and troubleshooting, and to create and
activate clients for username/password authentication, and activate
clients for client certificate authentication.</p>
</li>
<li><p class="first"><tt class="docutils literal">meld.py</tt></p>
<p>Command line client to the MineMeld config API requests used by
<tt class="docutils literal">gridmeld</tt> to update <tt class="docutils literal">localDB</tt> miner indicators.</p>
</li>
<li><p class="first"><tt class="docutils literal">gate.py</tt></p>
<p>Gateway application to consume session directory data from pxGrid
and publish IP indicators to a MineMeld <tt class="docutils literal">localDB</tt> miner node.</p>
</li>
</ul>
<p>Command options can be displayed using <tt class="docutils literal"><span class="pre">--help</span></tt> (e.g.,
<tt class="docutils literal">gate.py <span class="pre">--help</span></tt>).</p>
</div>
</div>
<div class="section" id="cisco-ise-pxgrid">
<h1><a class="toc-backref" href="#id9">Cisco ISE pxGrid</a></h1>
<p>ISE must be configured for pxGrid.  By default pxGrid is disabled and
can be enabled at Administration-&gt;Deployment-&gt;Deployment Nodes
List-&gt; <em>your ISE node</em>.</p>
<p>The <tt class="docutils literal">grid.py</tt> and <tt class="docutils literal">gate.py</tt> pxGrid clients can use either SSL
client certificate authentication or username/password
authentication.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ISE 2.4 or greater is required.  <tt class="docutils literal">gridmeld</tt> has been
tested with ISE 2.4.0.357.</p>
<p class="last">A pxGrid 2.0
<a class="reference external" href="https://developer.cisco.com/fileMedia/download/36c70887-c7bd-46b0-93c6-c6778ca62bd7">test-bed ISO image</a>
is available from the
<a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#getting-started">getting started</a>
section of the documentation.</p>
</div>
<div class="section" id="export-the-ise-certificate-services-root-ca">
<h2><a class="toc-backref" href="#id10">Export the ISE Certificate Services Root CA</a></h2>
<p>The <tt class="docutils literal">grid.py</tt> and <tt class="docutils literal">gate.py <span class="pre">--verify</span></tt> option is used to specify a
trusted CA certificate, or to disable server certificate
verification:</p>
<pre class="literal-block">
$ grid.py --hostname ise-2.santan.local --xversion
ClientConnectorSSLError: Cannot connect to host ise-2.santan.local:8910 ssl:&lt;ssl.SSLContext object at 0x66adb6d2898&gt; [[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:781)]
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The pxGrid version API request does not require client
authentication.</p>
</div>
<p>Verification fails because we do not have the trusted CA certificate.
<tt class="docutils literal"><span class="pre">--verify</span> no</tt> can be used to disable verification:</p>
<pre class="literal-block">
$ grid.py --verify no --hostname ise-2.santan.local --xversion -j
version: 200 OK None
&quot;2.0.0.13&quot;
</pre>
<p>To obtain the trusted CA certificate, export the <em>Certificate Services
Root CA</em> at Administration-&gt;System-&gt;Certificates-&gt;Certificate
Authority-&gt;CA Certificates.  With this CA certificate saved as
<tt class="docutils literal"><span class="pre">ise-ca.pem</span></tt> we can verify the pxGrid SSL server certificate:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --xversion -j
version: 200 OK None
&quot;2.0.0.13&quot;
</pre>
</div>
<div class="section" id="using-pxgrid-client-certificate-authentication">
<h2><a class="toc-backref" href="#id11">Using pxGrid Client Certificate Authentication</a></h2>
<p><a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#!generating-certificates/generating-certificates">Client certificate authentication</a>
can be used to authenticate the pxGrid client.
It is configured with the following steps:</p>
<ol class="arabic simple">
<li>Generate a key pair and public key certificate.</li>
<li>Convert the PKCS12 format file to PEM with no passphrase.</li>
<li>Activate the account using the <tt class="docutils literal">AccountActivate</tt> API request;
this places the account in the <em>PENDING</em> state.</li>
<li>The ISE administrator approves the account (unless automatic
approval is enabled); this places the account in the <em>ENABLED</em>
state.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Existing certificates can be viewed at
Administration-&gt;System-&gt;Certificates-&gt;Certificate
Authority-&gt;Issued Certificates.</p>
</div>
<div class="section" id="example-certificate-account-creation">
<h3><a class="toc-backref" href="#id12">Example: Certificate Account Creation</a></h3>
<ol class="arabic">
<li><p class="first">Generate client certificate.</p>
<p>pxGrid certificates are generated at Administration-&gt;pxGrid
Services-&gt;Certificates.  Here you should:</p>
<ul class="simple">
<li>Generate a single certificate (without a certificate signing
request).</li>
<li>Specify the username for the Common Name (CN).</li>
<li>Specify PKCS12 format.</li>
<li>Create the certificate.</li>
</ul>
<p>This exports a ZIP file containing a PKCS12 format file with the
client public key certificate and private key:</p>
<pre class="literal-block">
$ unzip 1544027591204_cert.zip
Archive:  1544027591204_cert.zip
  inflating: paloalto04_.p12
</pre>
</li>
<li><p class="first">Convert the PKCS12 format file to PEM.</p>
<p>The PKCS12 key file is converted to PEM with no passphrase using the
OpenSSL command line tool:</p>
<pre class="literal-block">
$ openssl pkcs12 -in paloalto04_.p12 -out paloalto04-nopw.pem -nodes
Enter Import Password:
MAC verified OK

$ ls -l paloalto04-nopw.pem
-rw-r--r--  1 ksteves  ksteves  11301 Dec  5 09:47 paloalto04-nopw.pem
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The openssl <tt class="docutils literal"><span class="pre">-nodes</span></tt> argument means <em>no DES</em>.</p>
</div>
<p>This certificate file can be used for the <tt class="docutils literal">grid.py</tt> and <tt class="docutils literal">gate.py
<span class="pre">--cert</span></tt> argument.</p>
</li>
<li><p class="first">Activate account.</p>
<p>Use the <tt class="docutils literal">grid.py</tt> program to activate the account using the
<tt class="docutils literal">AccountActivate</tt> API request with the client certificate file:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --activate -j --nodename paloalto04 --cert paloalto04-nopw.pem --desc 'test certificate account'
account_activate: 200 OK None
{
  &quot;accountState&quot;: &quot;PENDING&quot;,
  &quot;version&quot;: &quot;2.0.0.13&quot;
}
</pre>
</li>
<li><p class="first">Approve account.</p>
<p>The ISE administrator approves the account at
Administration-&gt;pxGrid Services-&gt;All Clients.</p>
<p>The approval can be verified by performing another activate
request; the state should now be <em>ENABLED</em>:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --activate -j --nodename paloalto04 --cert paloalto04-nopw.pem
account_activate: 200 OK None
{
  &quot;accountState&quot;: &quot;ENABLED&quot;,
  &quot;version&quot;: &quot;2.0.0.13&quot;
}
</pre>
</li>
</ol>
</div>
</div>
<div class="section" id="using-pxgrid-username-password-authentication">
<h2><a class="toc-backref" href="#id13">Using pxGrid Username/Password Authentication</a></h2>
<p><a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#!using-pre-shared-keys">Username/Password authentication</a>
is an alternative to client certificate authentication.</p>
<p>A pxGrid client account is configured with the following steps:</p>
<ol class="arabic">
<li><p class="first">Create the account using the <tt class="docutils literal">AccountCreate</tt> API request;
this provides a <em>password</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to allow a pxGrid client to register itself and
create the account via the REST API, you must enable
<em>Allow password based account creation</em> at
Administration-&gt;pxGrid Services-&gt;Settings; by default
this is disabled.  This can be disabled after the account
is created.</p>
</div>
</li>
<li><p class="first">Activate the account using the <tt class="docutils literal">AccountActivate</tt> API request;
this places the account in the <em>PENDING</em> state.</p>
</li>
<li><p class="first">The ISE administrator approves the account (unless automatic
approval is enabled); this places the account in the <em>ENABLED</em>
state.</p>
</li>
<li><p class="first">Obtain a shared secret for a peer node using the <tt class="docutils literal">AccessSecret</tt>
API request; the shared secret is unique for the REST and WebSocket
APIs.  <tt class="docutils literal">gate.py</tt> will determine the secret using the nodename
(username) and password provided when username/password
authentication is specified.</p>
</li>
</ol>
<div class="section" id="example-username-password-account-creation">
<h3><a class="toc-backref" href="#id14">Example: Username/Password Account Creation</a></h3>
<ol class="arabic">
<li><p class="first">Create account.</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --create -j --nodename paloalto03
account_create: 200 OK None
{
  &quot;nodeName&quot;: &quot;paloalto03&quot;,
  &quot;password&quot;: &quot;jtKm2m3VNdd2xYiF&quot;,
  &quot;userName&quot;: &quot;paloalto03&quot;
}
</pre>
</li>
<li><p class="first">Activate account.</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --activate -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF --desc 'test account'
account_activate: 200 OK None
{
  &quot;accountState&quot;: &quot;PENDING&quot;,
  &quot;version&quot;: &quot;2.0.0.13&quot;
}
</pre>
<p>You can now view the account with status <em>Pending</em> at
Administration-&gt;pxGrid Services-&gt;All Clients.</p>
</li>
<li><p class="first">Approve account.</p>
<p>The ISE administrator approves the account at
Administration-&gt;pxGrid Services-&gt;All Clients.</p>
<p>The approval can be verified by performing another activate
request; the state should now be <em>ENABLED</em>:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --activate -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF
account_activate: 200 OK None
{
  &quot;accountState&quot;: &quot;ENABLED&quot;,
  &quot;version&quot;: &quot;2.0.0.13&quot;
}
</pre>
</li>
<li><p class="first">Get shared secret.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The shared secret is only needed when using <tt class="docutils literal">grid.py</tt>
with username/password authentication; <tt class="docutils literal">gate.py</tt> will
automatically obtain the shared secrets using the
provided password.</p>
</div>
<p>The password is used to obtain a shared secret for a peer node.
The peer nodename depends on the service name, which is
<em>com.cisco.ise.session</em> for the session directory service, and
<em>com.cisco.ise.pubsub</em> for the session pubsub service.  A
<tt class="docutils literal">ServiceLookup</tt> API request is used to determine the peer node
given the service name, followed by an <tt class="docutils literal">AccessSecret</tt> API
request to determine the shared secret:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --lookup -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF --name com.cisco.ise.session
service_lookup: 200 OK None
{
  &quot;services&quot;: [
    {
      &quot;name&quot;: &quot;com.cisco.ise.session&quot;,
      &quot;nodeName&quot;: &quot;ise-mnt-ise-2&quot;,
      &quot;properties&quot;: {
        &quot;groupTopic&quot;: &quot;/topic/com.cisco.ise.session.group&quot;,
        &quot;restBaseURL&quot;: &quot;https://ise-2.santan.local:8910/pxgrid/mnt/sd&quot;,
        &quot;restBaseUrl&quot;: &quot;https://ise-2.santan.local:8910/pxgrid/mnt/sd&quot;,
        &quot;sessionTopic&quot;: &quot;/topic/com.cisco.ise.session&quot;,
        &quot;wsPubsubService&quot;: &quot;com.cisco.ise.pubsub&quot;
      }
    }
  ]
}

$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --lookup -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF --name com.cisco.ise.pubsub
service_lookup: 200 OK None
{
  &quot;services&quot;: [
    {
      &quot;name&quot;: &quot;com.cisco.ise.pubsub&quot;,
      &quot;nodeName&quot;: &quot;ise-pubsub-ise-2&quot;,
      &quot;properties&quot;: {
        &quot;wsUrl&quot;: &quot;wss://ise-2.santan.local:8910/pxgrid/ise/pubsub&quot;
      }
    }
  ]
}

$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --asecret -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF --peernode ise-mnt-ise-2
access_secret: 200 OK None
{
  &quot;secret&quot;: &quot;4FhaXqreXpK1FeBW&quot;
}

$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --asecret -j --nodename paloalto03 --password jtKm2m3VNdd2xYiF --peernode ise-pubsub-ise-2
access_secret: 200 OK None
{
  &quot;secret&quot;: &quot;Bx3HotDQuO7aZv36&quot;
}
</pre>
<p>The secret can be verified by performing a <tt class="docutils literal">getSessions</tt> API
request:</p>
<pre class="literal-block">
$ grid.py --verify ise-ca.pem --hostname ise-2.santan.local --nodename paloalto03 --sessions --baseurl 'https://ise-2.santan.local:8910/pxgrid/mnt/sd' --secret 4FhaXqreXpK1FeBW
get_sessions: 200 OK None
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can use the <tt class="docutils literal"><span class="pre">-j</span></tt> option to display the JSON response.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="palo-alto-networks-minemeld">
<h1><a class="toc-backref" href="#id15">Palo Alto Networks MineMeld</a></h1>
<p><a class="reference external" href="https://live.paloaltonetworks.com/t5/MineMeld/ct-p/MineMeld">MineMeld</a>
is an extensible Threat Intelligence processing framework and
the <em>multi-tool</em> of threat indicator feeds. Based on an extremely
flexible engine, MineMeld can be used to collect, aggregate and filter
indicators from a variety of sources and make them available for
consumption by the Palo Alto Networks security platform
and to multi-vendor peers.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal">gridmeld</tt> functionality is not available as a miner
because MineMeld is currently implemented using Python 2.7,
which does not support <tt class="docutils literal">asyncio</tt>.</p>
</div>
<div class="section" id="install-minemeld">
<h2><a class="toc-backref" href="#id16">Install MineMeld</a></h2>
<p>You will need to install an
<a class="reference external" href="https://github.com/PaloAltoNetworks/minemeld/wiki/User%27s-Guide">on-premises MineMeld</a>
or you can use an
<a class="reference external" href="https://www.paloaltonetworks.com/documentation/autofocus/autofocus/autofocus_admin_guide/autofocus-apps/minemeld/use-autofocus-hosted-minemeld">AutoFocus-hosted MineMeld</a>
in the cloud.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using AutoFocus-hosted MineMeld you need to allow
inbound API access from the cloud to your PAN-OS firewalls
or Panoramas to allow <tt class="docutils literal"><span class="pre">registered-ip</span></tt> object updates from
the <tt class="docutils literal">dagPusher</tt> output node.</p>
</div>
</div>
<div class="section" id="minemeld-nodes-configuration">
<h2><a class="toc-backref" href="#id17">MineMeld Nodes Configuration</a></h2>
<p>The configuration required is a <tt class="docutils literal">localDB</tt> miner node connected to
a <tt class="docutils literal">dagPusherNg</tt> output node.</p>
<div class="section" id="stdlib-localdb-miner">
<h3><a class="toc-backref" href="#id18"><tt class="docutils literal">stdlib.localDB</tt> Miner</a></h3>
<p>The class <tt class="docutils literal">minemeld.ft.localdb.Miner</tt> implements a miner with a
database containing indicators of various types (e.g., <em>IPv4</em> and
<em>IPv6</em>) and attributes for the indicators.  The <tt class="docutils literal">stdlib.localDB</tt>
prototype is used to create the miner node.</p>
<p><tt class="docutils literal">gridmeld</tt> will populate the <tt class="docutils literal">localDB</tt> node with IP indicators
from pxGrid sessions using the MineMeld config API.  The indicator
<tt class="docutils literal">sgt</tt> attribute will contain the SGT for each IP in the session.</p>
</div>
<div class="section" id="dagpusherng-output-node">
<h3><a class="toc-backref" href="#id19"><tt class="docutils literal">dagPusherNg</tt> Output Node</a></h3>
<p>The class <tt class="docutils literal">minemeld.ft.dag_ng.DagPusher</tt> implements an output node
which consumes indicators from an input node, in this case a
<tt class="docutils literal">localDB</tt> node, and uses the PAN-OS XML API to synchronize the
indicators as <tt class="docutils literal"><span class="pre">registered-ip</span></tt> objects on configured firewalls and
Panoramas.  The <tt class="docutils literal">dagPusherNg</tt> prototype is used to create the output
node.</p>
<p>The prototype configuration specifies <tt class="docutils literal">tag_attributes</tt>, which are
the indicator attributes in <tt class="docutils literal">localDB</tt> that will be used for the
<tt class="docutils literal"><span class="pre">registered-ip</span></tt> object tags.  The configuration can also specify a
<tt class="docutils literal">tag_prefix</tt> which is used to identify tags owned by the node; the
default is <tt class="docutils literal">mmld_</tt>.  The tag name will be the concatenation of
<em>tag_prefix</em>, <em>tag_attribute</em> and <em>attribute</em>; for example:
<tt class="docutils literal">mmld_sgt_Employees</tt>.</p>
<p><a class="reference external" href="https://docs.paloaltonetworks.com/pan-os/9-0/pan-os-admin/policy/monitor-changes-in-the-virtual-environment/use-dynamic-address-groups-in-policy">Dynamic Address Group objects</a>
(DAGs) can be created by using the object tags in a match expression.
The DAGs can be used in a security policy as source and destination
for policy enforcement.</p>
</div>
<div class="section" id="dagpusher-implementations">
<h3><a class="toc-backref" href="#id20"><tt class="docutils literal">dagPusher</tt> Implementations</a></h3>
<p>There are two <tt class="docutils literal">dagPusher</tt> implementations:</p>
<ul>
<li><p class="first">class <tt class="docutils literal">minemeld.ft.dag.DagPusher</tt> (prototype <tt class="docutils literal">stdlib.dagPusher</tt>)</p>
<p>This is the legacy node and should only be used if you are using
Autofocus-hosted MineMeld, or when the devices are using PAN-OS
7.1.</p>
</li>
<li><p class="first">class <tt class="docutils literal">minemeld.ft.dag_ng.DagPusher</tt> (prototype
<tt class="docutils literal">stdlib.dagPusherNg</tt>)</p>
<p>This is the next generation node and is the recommended
implementation to use.  It contains a number of functional and
performance enhancements made to the legacy node.  It requires
PAN-OS 8.0 or greater.  <tt class="docutils literal">dagPusherNg</tt> is available starting with
MineMeld 0.9.62.</p>
</li>
</ul>
</div>
<div class="section" id="nodes-configuration">
<h3><a class="toc-backref" href="#id21">Nodes Configuration</a></h3>
<p>We first need to create a local prototype from the pre-defined
<tt class="docutils literal">stdlib.dagPusherNg</tt> prototype so we can add the <tt class="docutils literal">sgt</tt>
attribute to the <tt class="docutils literal">tag_attributes</tt> config.</p>
<p>A <tt class="docutils literal"><span class="pre">minemeldlocal.stdlib_dagPusherNg-sgt</span></tt> prototype is created at
CONFIG-&gt;browse prototypes-&gt;Search &quot;dagPusherNg&quot;-&gt;select
&quot;stdlib.dagPusherNg&quot;.  Then create a new local prototype from
<tt class="docutils literal">stdlib.dagPusherNg</tt> using <strong>NEW</strong> (create prototype from this) and
add a config of <tt class="docutils literal">{ &quot;tag_attributes&quot;: [&quot;sgt&quot;] }</tt>.  This will result
in the following prototype in
<tt class="docutils literal">/opt/minemeld/local/minemeldlocal.yml</tt> (we named the new prototype
<tt class="docutils literal"><span class="pre">stdlib_dagPusherNg-sgt</span></tt>):</p>
<pre class="literal-block">
prototypes:
    stdlib_dagPusherNg-sgt:
        class: minemeld.ft.dag_ng.DagPusher
        config:
            tag_attributes:
            - sgt
        description: 'Push IP unicast indicators to PAN-OS 8.0 and greater devices
            via DAG.

            '
        development_status: EXPERIMENTAL
        indicator_types:
        - IPv4
        - IPv6
        node_type: output
        tags: []
</pre>
<p>Next we add a miner node using the <tt class="docutils literal">stdlib.localDB</tt> prototype
at CONFIG-&gt;browse prototypes-&gt;Search &quot;localDB&quot;-&gt;select &quot;stdlib.localDB&quot;,
then <strong>CLONE</strong> (new node from this prototype).</p>
<p>Then we add the output node at CONFIG-&gt;browse prototypes-&gt;Search
&quot;stdlib_dagPusherNg-sgt&quot;-&gt;select
&quot;minemeldlocal.stdlib_dagPusherNg-sgt&quot;, then <strong>CLONE</strong> (new node from
this prototype), and specify the <tt class="docutils literal">localDB</tt> node created above as
<strong>INPUT</strong> (this connects the output node to the input node).</p>
<p>Then <strong>COMMIT</strong> the configuration.</p>
<p>The nodes configuration, connecting the <tt class="docutils literal">localDB</tt> miner to the
<tt class="docutils literal">dagPusherNg</tt> output node can be viewed in
<tt class="docutils literal"><span class="pre">/opt/minemeld/local/config/running-config.yml</span></tt>:</p>
<pre class="literal-block">
nodes:
  localDB-1561848312020:
    inputs: []
    output: true
    prototype: stdlib.localDB
  stdlib_dagPusherNg-sgt-1561848485387:
    inputs:
    - localDB-1561848312020
    output: false
    prototype: minemeldlocal.stdlib_dagPusherNg-sgt
</pre>
</div>
<div class="section" id="stdlib-dagpusherng-sgt-node-configuration">
<h3><a class="toc-backref" href="#id22"><tt class="docutils literal"><span class="pre">stdlib_dagPusherNg-sgt</span></tt> Node Configuration</a></h3>
<p>The PAN-OS firewalls and Panoramas to be updated with
<tt class="docutils literal"><span class="pre">registered-ip</span></tt> objects representing IP-SGT mappings are configured
in the node's <strong>DEVICES</strong> tab.  This updates a device list file
containing YAML.  The device list resides in the
<tt class="docutils literal">/opt/minemeld/local/config</tt> directory and is named <em>node</em><tt class="docutils literal">_device_list.yml</tt>, where <em>node</em> is the name of the output node:</p>
<pre class="literal-block">
$ cat /opt/minemeld/local/config/stdlib_dagPusherNg-sgt-1561848485387_device_list.yml
- {api_password: admin, api_username: admin, hostname: 192.168.1.102, name: vm-50-1}
- {api_password: admin, api_username: admin, hostname: 192.168.1.110, name: pa-220-2}
</pre>
<p>The device list file can also be created and updated manually.
The device configuration variables are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="11%" />
<col width="41%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Variable Name</th>
<th class="head">Type</th>
<th class="head">Description</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>hostname</td>
<td>string</td>
<td>PAN-OS hostname or IP address</td>
<td>null</td>
</tr>
<tr><td>api_username</td>
<td>string</td>
<td>user for type=keygen</td>
<td>null</td>
</tr>
<tr><td>api_password</td>
<td>string</td>
<td>password for type=keygen</td>
<td>null</td>
</tr>
<tr><td>api_key</td>
<td>string</td>
<td>key for API requests</td>
<td>null</td>
</tr>
<tr><td>name</td>
<td>string</td>
<td>optional friendly hostname</td>
<td>null</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The device list file is a list of dictionaries.</p>
<p>You must specify either <tt class="docutils literal">api_key</tt>, or <tt class="docutils literal">api_username</tt> and
<tt class="docutils literal">api_password</tt>.</p>
<p class="last">The <strong>DEVICES</strong> tab does not currently allow you to specify an <tt class="docutils literal">api_key</tt>.
To use API keys you can update the device list file manually.</p>
</div>
</div>
</div>
<div class="section" id="minemeld-config-api">
<h2><a class="toc-backref" href="#id23">MineMeld Config API</a></h2>
<p>The MineMeld config API is used to add and delete indicators in the
<tt class="docutils literal">localDB</tt> miner.  The <tt class="docutils literal">meld.py</tt> and <tt class="docutils literal">gate.py</tt> programs require the
URI of the MineMeld host and an admin username and password.</p>
<p>As a best practice it is recommended to add a <tt class="docutils literal">gridmeld</tt> admin;
admin users are managed in the <strong>ADMIN</strong> tab in the MineMeld UI.</p>
<p><tt class="docutils literal">meld.py</tt> and <tt class="docutils literal">gate.py</tt> also have a <tt class="docutils literal"><span class="pre">--verify</span></tt> option to specify
the trusted CA certificate for server certificate verification.  If your
MineMeld has a self signed certificate, you can obtain it using the
OpenSSL command line tool:</p>
<pre class="literal-block">
$ echo | openssl s_client -connect minemeld.santan.local:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' &gt; mm-cert.pem
depth=0 CN = minemeld.santan.local
verify error:num=18:self signed certificate
verify return:1
depth=0 CN = minemeld.santan.local
verify return:1
DONE
</pre>
<p>API access can be verified by performing a <tt class="docutils literal">status</tt> API request:</p>
<pre class="literal-block">
$ meld.py --verify mm-cert.pem --uri https://minemeld.santan.local --username gridmeld --password paloalto --status
status: 200 OK 698
</pre>
</div>
</div>
<div class="section" id="running-the-gridmeld-gateway-application">
<h1><a class="toc-backref" href="#id24">Running the <tt class="docutils literal">gridmeld</tt> Gateway Application</a></h1>
<p><tt class="docutils literal">gate.py</tt> is the <tt class="docutils literal">gridmeld</tt> gateway application program:</p>
<pre class="literal-block">
$ gate.py --help
gate.py [options]
    --minemeld               MineMeld options follow
      --uri uri              MineMeld URI
      --username username    API username
      --password password    API password
      --node name            localDB miner node name
      --verify opt           SSL server verify option: yes|no|path
      --timeout timeout      connect, read timeout
      --policy path          JSON session processing policy object
      -F path                JSON options (multiple -F's allowed)
    --pxgrid                 pxGrid options follow
      --hostname hostname    ISE hostname (multiple --hostname's allowed)
      --nodename nodename    pxGrid client nodename (username)
      --password password    pxGrid client password
      --cert path            SSL client certificate file
      --verify opt           SSL server verify option: yes|no|path
      --timeout timeout      connect, read timeout
      --replay json          replay session objects
      -F path                JSON options (multiple -F's allowed)
    --syslog facility        log to syslog with facility
                             (default: log to stderr)
    --daemon                 run as a daemon
                             (default: run in foreground)
    -T                       add time to default stderr log format
    --debug level            debug level (0-3)
    --version                display version
    --help                   display usage
</pre>
<p><tt class="docutils literal">gate.py</tt> performs the following:</p>
<ol class="arabic simple">
<li>Set signal handler for <strong>SIGINT</strong> and <strong>SIGTERM</strong> for program
termination.  <tt class="docutils literal">gate.py</tt> will run until it receives a signal
or encounters an unrecoverable error.</li>
<li>Parse command options.</li>
<li>Initialize MineMeld.<ul>
<li>Verify <tt class="docutils literal">localDB</tt> miner node specified using the config API.</li>
</ul>
</li>
<li>Initialize pxGrid.<ul>
<li>Obtain all required API parameters using the REST API (e.g.,
obtain secret for session directory and pubsub service using
password).</li>
</ul>
</li>
<li>Invoke MineMeld and pxGrid loops, which run concurrently.</li>
<li>pxGrid loop:<ul>
<li>Get existing indicators in MineMeld <tt class="docutils literal">localDB</tt> miner node.</li>
<li>Perform bulk download of all existing sessions using the REST API.</li>
<li>Sync sessions with <tt class="docutils literal">localDB</tt> indicators.</li>
<li>Subscribe to session directory updates using the WebSocket API.</li>
<li>Send session updates to MineMeld loop (using an asyncio queue).</li>
</ul>
</li>
<li>MineMeld loop:<ul>
<li>Read session events from the queue.</li>
<li>Process events according to the session policy by adding or
deleting indicators in the <tt class="docutils literal">localDB</tt> node.</li>
</ul>
</li>
</ol>
<p>By default <tt class="docutils literal">gate.py</tt> logs to <strong>stderr</strong> and runs in the foreground.
It can run in the background by specifying the <tt class="docutils literal"><span class="pre">--daemon</span></tt> option,
and log to <strong>syslog</strong> using the <tt class="docutils literal"><span class="pre">--syslog</span></tt> option.  When
<tt class="docutils literal"><span class="pre">--daemon</span></tt> is used certificate files must be a full path because the
current working directory is changed to root (/).</p>
<p><tt class="docutils literal">gate.py</tt> requires no privilege and should not be run as root.  It
is recommended to add a new powerless no login account such as
<tt class="docutils literal">gridmeld</tt> and run <tt class="docutils literal">gate.py</tt> as this user.</p>
<p>It is also recommended that <tt class="docutils literal">gridmeld</tt> be run under a service
manager such as <tt class="docutils literal">systemd</tt> for automatic start at system boot, and
re-start on program failure.</p>
<div class="section" id="minemeld-and-pxgrid-json-options">
<h2><a class="toc-backref" href="#id25">MineMeld and pxGrid JSON Options</a></h2>
<p>MineMeld and pxGrid options can be specified in a JSON format file
using the <tt class="docutils literal"><span class="pre">--minemeld</span></tt> or <tt class="docutils literal"><span class="pre">--pxgrid</span></tt> option followed by the <tt class="docutils literal"><span class="pre">-F</span></tt>
option; for example using the configuration discussed previously:</p>
<pre class="literal-block">
$ cat gate-mm.json
{
    &quot;uri&quot;: &quot;https://minemeld.santan.local&quot;,
    &quot;username&quot;: &quot;gridmeld&quot;,
    &quot;password&quot;: &quot;paloalto&quot;,
    &quot;node&quot;: &quot;localDB-1561848312020&quot;,
    &quot;verify&quot;: &quot;mm-cert.pem&quot;
}

$ cat gate-ise-pw.json
{
    &quot;hostname&quot;: [&quot;ise-2.santan.local&quot;],
    &quot;nodename&quot;: &quot;paloalto03&quot;,
    &quot;password&quot;: &quot;jtKm2m3VNdd2xYiF&quot;,
    &quot;verify&quot;: &quot;ise-ca.pem&quot;
}
</pre>
</div>
<div class="section" id="minemeld-session-processing-policy">
<h2><a class="toc-backref" href="#id26">MineMeld Session Processing Policy</a></h2>
<p>By default the MineMeld loop processes pxGrid session objects as
follows:</p>
<ul class="simple">
<li><em>IPv4</em> and <em>IPv6</em> indicator types will be processed.</li>
<li>Hosts in all IP networks are processed.</li>
<li><a class="reference external" href="https://github.com/cisco-pxgrid/pxgrid-rest-ws/wiki/Session-Directory#session-object">session object</a>
<tt class="docutils literal">ctsSecurityGroup</tt> and <tt class="docutils literal">userName</tt> fields are mapped to <tt class="docutils literal">localDB</tt>
<tt class="docutils literal">sgt</tt> and <tt class="docutils literal">user</tt> attributes.</li>
</ul>
<p>The default policy is represented by the JSON object:</p>
<pre class="literal-block">
{
    &quot;indicator_types&quot;: [&quot;IPv4&quot;, &quot;IPv6&quot;],
    &quot;include_networks&quot;: [],
    &quot;exclude_networks&quot;: [],
    &quot;attribute_map&quot;: {
        &quot;ctsSecurityGroup&quot;: &quot;sgt&quot;,
        &quot;userName&quot;: &quot;user&quot;
    }
}
</pre>
<p>The <tt class="docutils literal">gate.py <span class="pre">--minemeld</span> <span class="pre">--policy</span></tt> <em>path</em> option can be used to
change the default policy.  The JSON object specified will be merged
with the default policy using the Python <tt class="docutils literal">dict.update()</tt> method
(top-level key/value pairs in the default object are overwritten
by keys in the <tt class="docutils literal"><span class="pre">--policy</span></tt> object specified).</p>
<div class="section" id="session-policy-examples">
<h3><a class="toc-backref" href="#id27">Session Policy Examples</a></h3>
<p>The following JSON object will update the default policy to include
the <tt class="docutils literal">endpointOperatingSystem</tt> field using the <tt class="docutils literal">localDB</tt> <tt class="docutils literal">os</tt>
attribute when it exists in a session.</p>
<pre class="literal-block">
$ cat policy1.json
{
    &quot;attribute_map&quot;: {
        &quot;ctsSecurityGroup&quot;: &quot;sgt&quot;,
        &quot;userName&quot;: &quot;user&quot;,
        &quot;endpointOperatingSystem&quot;: &quot;os&quot;
    }
}
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal">localDB</tt> attribute names must not begin with the
underscore character (<strong>_</strong>).</p>
</div>
<p>The following JSON object will update the default policy to process
only <em>IPv4</em> indicator types.</p>
<pre class="literal-block">
$ cat policy2.json
{
    &quot;indicator_types&quot;: [&quot;IPv4&quot;]
}
</pre>
<p>The following JSON object will update the default policy to only
process (include) hosts in network 10.0.0.0/8 and not process
(exclude) hosts in networks 10.2.100.0/24 and 10.3.100.0/24.</p>
<p>Networks are specified as <em>prefix/length</em> and IPv4 and IPv6 networks
are allowed.  The policy match order is <em>include</em> then <em>exclude</em>, and
the empty list means <em>include all</em> and <em>exclude none</em> respectively.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Python <a class="reference external" href="https://docs.python.org/3/library/ipaddress.html">ipaddress</a>
module <tt class="docutils literal">ip_network()</tt> function is used to create
the network object and test for hosts in the networks.</p>
</div>
<pre class="literal-block">
$ cat policy3.json
{
    &quot;include_networks&quot;: [&quot;10.0.0.0/8&quot;],
    &quot;exclude_networks&quot;: [&quot;10.2.100.0/24&quot;, &quot;10.3.100.0/24&quot;]
}
</pre>
</div>
</div>
<div class="section" id="gate-py-example">
<h2><a class="toc-backref" href="#id28"><tt class="docutils literal">gate.py</tt> Example</a></h2>
<pre class="literal-block">
$ gate.py --minemeld -F gate-mm.json --pxgrid -F gate-ise-pw.json
INFO gate.py starting (gridmeld 0.4.0)
INFO gate.py Python 3.7.3 OpenBSD 6.5 GENERIC.MP#1
INFO gate.py MineMeld 0.9.60
INFO gate.py pxGrid 2.0.0.13
INFO gate.py MineMeld session policy {'indicator_types': ['IPv4', 'IPv6'], 'attribute_map': {'ctsSecurityGroup': 'sgt', 'userName': 'user'}}
INFO gridmeld.pxgrid.wsstomp get_sessions(): 2 session objects
INFO gridmeld.pxgrid.wsstomp processing events from wss://ise-3.santan.local:8910/pxgrid/ise/pubsub /topic/com.cisco.ise.session
INFO gate.py SDB size after session sync: 2
INFO gate.py 172.16.1.101 STARTED: {'sgt': 'Contractors', 'user': 'user101'}
INFO gate.py SDB size: 3: indicators (up to 5): ['172.16.1.100', '172.16.1.102', '172.16.1.101']
INFO gate.py 172.16.1.100 DISCONNECTED: {'sgt': 'Auditors', 'user': 'user100'}
INFO gate.py SDB size: 2: indicators (up to 5): ['172.16.1.102', '172.16.1.101']
INFO gate.py 172.16.1.101 DISCONNECTED: {'sgt': 'Contractors', 'user': 'user101'}
INFO gate.py SDB size: 1: indicators (up to 5): ['172.16.1.102']
INFO gate.py 172.16.1.102 DISCONNECTED: {'sgt': 'Employees', 'user': 'user102'}
INFO gate.py SDB size: 0
INFO gate.py 172.16.1.100 STARTED: {'sgt': 'Auditors', 'user': 'user100'}
INFO gate.py SDB size: 1: indicators (up to 5): ['172.16.1.100']
</pre>
<p>Verify <tt class="docutils literal"><span class="pre">registered-ip</span></tt> objects are being pushed to a configured PAN-OS
system:</p>
<pre class="literal-block">
admin&#64;pa-220&gt; show object registered-ip all

registered IP                             Tags
----------------------------------------  -----------------

172.16.1.100 #
                                         &quot;mmld_pushed (never expire)&quot;
                                         &quot;mmld_sgt_Auditors (never expire)&quot;

172.16.1.101 #
                                         &quot;mmld_pushed (never expire)&quot;
                                         &quot;mmld_sgt_Contractors (never expire)&quot;

::
                                         &quot;mmld_canary_for_resync (expire in 322 seconds)&quot;

172.16.1.102 #
                                         &quot;mmld_pushed (never expire)&quot;
                                         &quot;mmld_sgt_Employees (never expire)&quot;

Total: 4 registered addresses
*: received from user-id agent  #: persistent
</pre>
<p>When run in the foreground, <tt class="docutils literal">gate.py</tt> is terminated with ^C (Control-C):</p>
<pre class="literal-block">
^CINFO gate.py got SIGINT, exiting
INFO gate.py loop_minemeld exiting
INFO gate.py loop_pxgrid exiting
INFO gate.py loop_main exiting
INFO gate.py exiting
</pre>
</div>
</div>
<div class="section" id="ubuntu-18-04-configuration">
<h1><a class="toc-backref" href="#id29">Ubuntu 18.04 Configuration</a></h1>
<p>This section covers recommended system configuration tasks on Ubuntu
18.04.</p>
<div class="section" id="rsyslogd">
<h2><a class="toc-backref" href="#id30">rsyslogd</a></h2>
<p>The <tt class="docutils literal">gate.py <span class="pre">--syslog</span></tt> option is used to specify that syslog is used
for logging, and to specify the log facility to use.  On Ubuntu
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/man8/rsyslogd.8.html">rsyslogd</a> is
used for system logging, and when using one of the <tt class="docutils literal">local0</tt> through
<tt class="docutils literal">local7</tt> facilities the log file is <tt class="docutils literal">/var/log/syslog</tt>.  You can
configure <tt class="docutils literal">rsyslogd</tt> to use another log file such as
<tt class="docutils literal">/var/log/gridmeld.log</tt> with the following steps:</p>
<pre class="literal-block">
$ cat 20-gridmeld.conf
local0.debug                    /var/log/gridmeld.log
# Comment out the following line to allow further message processing.
# This means you'll also get messages in /var/log/syslog.
&amp; stop

$ sudo bash
# &gt;/var/log/gridmeld.log
# chmod 640 /var/log/gridmeld.log
# chown syslog:adm /var/log/gridmeld.log

# cp 20-gridmeld.conf /etc/rsyslog.d/
# systemctl restart rsyslog
</pre>
</div>
<div class="section" id="logrotate">
<h2><a class="toc-backref" href="#id31">logrotate</a></h2>
<p>After configuring <tt class="docutils literal">rsyslogd</tt> to log to a new log file, you should
configure it for log rotation.  Ubuntu uses
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/man8/logrotate.8.html">logrotate</a>
for log file rotation.  You can configure <tt class="docutils literal">logrotate</tt> for rotation
of the new log file with the following steps:</p>
<pre class="literal-block">
$ cat gridmeld
/var/log/gridmeld.log
{
        rotate 7
        daily
        missingok
        notifempty
        delaycompress
        compress
}

$ sudo cp gridmeld /etc/logrotate.d/
</pre>
</div>
<div class="section" id="systemd">
<h2><a class="toc-backref" href="#id32">systemd</a></h2>
<p><a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/man1/systemd.1.html">systemd</a> is
a system and service manager for Linux, and is the default init system
in Ubuntu since 16.04.  The following describes how to install and
enable a custom <tt class="docutils literal">systemd</tt> service unit file on Ubuntu 18.04 for
<tt class="docutils literal">gate.py</tt>.  This will start <tt class="docutils literal">gate.py</tt> at system boot, and restart
it when it exits.</p>
<div class="section" id="access-control">
<h3><a class="toc-backref" href="#id33">Access Control</a></h3>
<p><tt class="docutils literal">gate.py</tt> will run as user <tt class="docutils literal">gridmeld</tt>, group <tt class="docutils literal">gridmeld</tt> using
the service unit <em>User</em> and <em>Group</em> options.</p>
<p>Directories for configuration files will be owner root:gridmeld and
mode 750.  Configuration files will be owner root:root and mode 644.</p>
<p>gridmeld:gridmeld is a powerless user and group that can read the
configuration files but cannot modify them.</p>
</div>
<div class="section" id="create-gridmeld-user-and-group">
<h3><a class="toc-backref" href="#id34">Create <tt class="docutils literal">gridmeld</tt> user and group</a></h3>
<pre class="literal-block">
$ sudo bash
# groupadd gridmeld
# useradd -g gridmeld -s /usr/sbin/nologin gridmeld
</pre>
</div>
<div class="section" id="create-opt-gridmeld-for-config">
<h3><a class="toc-backref" href="#id35">Create <tt class="docutils literal">/opt/gridmeld</tt> for Config</a></h3>
<p>The following directory structure is created:</p>
<ul>
<li><p class="first"><tt class="docutils literal">/opt/gridmeld/etc/</tt></p>
<p>Used for JSON -F config files.</p>
</li>
<li><p class="first"><tt class="docutils literal">/opt/gridmeld/ssl/</tt></p>
<p>Used for SSL server certificates.</p>
</li>
<li><p class="first"><tt class="docutils literal">/opt/gridmeld/ssl/private/</tt></p>
<p>Used for SSL private keys.</p>
</li>
</ul>
<pre class="literal-block">
# mkdir -p /opt/gridmeld/etc/
# mkdir -p /opt/gridmeld/ssl/private/
# find /opt/gridmeld -type d -exec chown root:gridmeld {} \;
# find /opt/gridmeld -type d -exec chmod 750 {} \;
</pre>
</div>
<div class="section" id="sample-json-config-files">
<h3><a class="toc-backref" href="#id36">Sample JSON Config Files</a></h3>
<pre class="literal-block">
$ cat gate-mm.json
{
    &quot;uri&quot;: &quot;https://minemeld.santan.local&quot;,
    &quot;username&quot;: &quot;gridmeld&quot;,
    &quot;password&quot;: &quot;paloalto&quot;,
    &quot;node&quot;: &quot;localDB-1554312231193&quot;,
    &quot;verify&quot;: &quot;/opt/gridmeld/ssl/mm-cert.pem&quot;
}

$ cat gate-ise.json
{
    &quot;hostname&quot;: [&quot;ise-3.santan.local&quot;],
    &quot;nodename&quot;: &quot;paloalto04&quot;,
    &quot;verify&quot;: &quot;/opt/gridmeld/ssl/ise3-ca.pem&quot;,
    &quot;cert&quot;: &quot;/opt/gridmeld/ssl/private/ise3-paloalto04-nopw.pem&quot;
}
</pre>
</div>
<div class="section" id="install-json-config-files">
<h3><a class="toc-backref" href="#id37">Install JSON Config Files</a></h3>
<p>Copy your JSON files for the <tt class="docutils literal"><span class="pre">--pxgrid</span></tt> and <tt class="docutils literal"><span class="pre">--minemeld</span> <span class="pre">-F</span></tt>
options into <tt class="docutils literal">/opt/gridmeld/etc/</tt>, for example:</p>
<pre class="literal-block">
$ sudo bash
# cp gate-ise.json /opt/gridmeld/etc/
# cp gate-mm.json /opt/gridmeld/etc/
</pre>
</div>
<div class="section" id="install-ssl-certificates-and-private-keys">
<h3><a class="toc-backref" href="#id38">Install SSL Certificates and Private Keys</a></h3>
<p>If you have certificate files for the <tt class="docutils literal"><span class="pre">--verify</span></tt> options, copy them
into <tt class="docutils literal">/opt/gridmeld/ssl/</tt>, for example:</p>
<pre class="literal-block">
# cp ise-ca.pem /opt/gridmeld/ssl/
# cp mm-ca.pem /opt/gridmeld/ssl/
</pre>
<p>If you are using client certificate authentication for pxGrid, copy
the SSL private key into <tt class="docutils literal">/opt/gridmeld/ssl/private/</tt>, for example:</p>
<pre class="literal-block">
# cp ise-paloalto04-nopw.pem /opt/gridmeld/ssl/private/
</pre>
</div>
<div class="section" id="set-file-owner-and-mode">
<h3><a class="toc-backref" href="#id39">Set File Owner and Mode</a></h3>
<p>After populating the config directory you should set owner:group and
mode for the files using:</p>
<pre class="literal-block">
# find /opt/gridmeld -type f -exec chown root:root {} \;
# find /opt/gridmeld -type f -exec chmod 644 {} \;
</pre>
</div>
<div class="section" id="configure-systemd-gridmeld-service-unit-file">
<h3><a class="toc-backref" href="#id40">Configure systemd gridmeld Service Unit File</a></h3>
<p>Modify the <tt class="docutils literal">gridmeld.service</tt> unit file <em>Environment</em> options as
needed for your environment:</p>
<pre class="literal-block">
$ cat gridmeld.service
[Unit]
Description=Palo Alto Networks gridmeld Gateway
Documentation=https://github.com/PaloAltoNetworks/gridmeld
After=network.target

[Service]
Environment=PXGRID='--pxgrid -F /opt/gridmeld/etc/gate-ise.json'
Environment=MINEMELD='--minemeld -F /opt/gridmeld/etc/gate-mm.json'
Environment=ARGS='--syslog local0'
Type=simple
Restart=always
RestartSec=10s
User=gridmeld
Group=gridmeld
ExecStart=/usr/local/bin/gate.py $PXGRID $MINEMELD $ARGS

[Install]
WantedBy=multi-user.target
</pre>
<p>Copy the service unit file in place and verify:</p>
<pre class="literal-block">
$ sudo cp gridmeld.service /lib/systemd/system
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Polkit
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/man8/pklocalauthority.8.html">Local Authority</a>
will manage administrator authentication when required via a configuration
of <tt class="docutils literal"><span class="pre">AdminIdentities=unix-group:sudo</span></tt>; sudo is not
used below for <tt class="docutils literal">systemctl</tt> commands, although it can be used if desired.</p>
</div>
<pre class="literal-block">
$ systemctl daemon-reload
$ systemctl start gridmeld
$ systemctl status gridmeld
</pre>
<p>Troubleshooting can be performed by querying the contents of
the systemd journal using
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/man1/journalctl.1.html">journalctl</a>:</p>
<pre class="literal-block">
$ journalctl -n -u gridmeld
$ journalctl -f -u gridmeld
</pre>
<p>Enable the service to start on boot and verify it is started after
a system reboot:</p>
<pre class="literal-block">
$ systemctl stop gridmeld
$ systemctl enable gridmeld
$ systemctl reboot
</pre>
<p>Wait for boot, then check the service status:</p>
<pre class="literal-block">
$ systemctl status gridmeld
</pre>
</div>
</div>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id41">References</a></h1>
<ul class="simple">
<li><a class="reference external" href="https://github.com/PaloAltoNetworks/gridmeld">gridmeld GitHub Repository</a></li>
<li><a class="reference external" href="https://docs.paloaltonetworks.com/pan-os/9-0/pan-os-admin/policy/register-ip-addresses-and-tags-dynamically">Register IP Addresses and Tags Dynamically on PAN-OS</a></li>
<li><a class="reference external" href="https://docs.paloaltonetworks.com/pan-os/9-0/pan-os-admin/policy/monitor-changes-in-the-virtual-environment/use-dynamic-address-groups-in-policy">Use Dynamic Address Groups in Policy on PAN-OS (includes
registered-ip object capacity for each model)</a></li>
<li><a class="reference external" href="https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/minemeld">Palo Alto Networks MineMeld</a></li>
<li><a class="reference external" href="https://live.paloaltonetworks.com/t5/MineMeld/ct-p/MineMeld">MineMeld Community</a></li>
<li><a class="reference external" href="https://github.com/PaloAltoNetworks/minemeld">MineMeld GitHub Repository</a></li>
<li><a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#!introduction-to-pxgrid-2-0">pxGrid 2.0</a></li>
<li><a class="reference external" href="https://github.com/cisco-pxgrid/pxgrid-rest-ws">pxGrid 2.0 API Sample Code GitHub Repository</a></li>
<li><a class="reference external" href="https://developer.cisco.com/docs/pxgrid/#whitepaper">pxGrid Whitepaper</a></li>
<li><a class="reference external" href="https://developer.cisco.com/fileMedia/download/36c70887-c7bd-46b0-93c6-c6778ca62bd7">ISE 2.4 test-bed ISO image</a></li>
</ul>
</div>
</div>
</body>
</html>
