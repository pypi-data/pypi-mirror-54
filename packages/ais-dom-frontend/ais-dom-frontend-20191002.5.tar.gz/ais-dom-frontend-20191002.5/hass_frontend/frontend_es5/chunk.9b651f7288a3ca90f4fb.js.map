{"version":3,"sources":["webpack:///./src/panels/lovelace/common/structs/struct.ts","webpack:///./src/panels/lovelace/common/structs/is-entity-id.ts","webpack:///./src/panels/lovelace/common/structs/is-icon.ts","webpack:///./src/panels/lovelace/components/hui-yaml-editor.ts","webpack:///./src/panels/lovelace/hui-editor.ts"],"names":["__webpack_require__","d","__webpack_exports__","struct","Object","index_es","types","entity-id","value","includes","icon","_super","HuiYamlEditor","_this","call","this","codemirror__WEBPACK_IMPORTED_MODULE_1___default","a","commands","save","cm","_common_dom_fire_event__WEBPACK_IMPORTED_MODULE_4__","getWrapperElement","_value","attachShadow","mode","innerHTML","codemirror_lib_codemirror_css__WEBPACK_IMPORTED_MODULE_3__","tslib__WEBPACK_IMPORTED_MODULE_0__","defineProperty","prototype","hass","_hass","setScrollBarDirection","codemirror","getValue","setValue","shadowRoot","querySelector","connectedCallback","refresh","lineNumbers","tabSize","autofocus","viewportMargin","Infinity","extraKeys","Tab","Shift-Tab","gutters","_common_util_compute_rtl__WEBPACK_IMPORTED_MODULE_5__","on","_onChange","classList","toggle","lit_element__WEBPACK_IMPORTED_MODULE_6__","HTMLElement","lovelaceStruct","_common_structs_struct__WEBPACK_IMPORTED_MODULE_10__","interface","title","views","resources","optional","LovelaceFullConfigEditor","lovelace","closeEditor","_saving","_changed","render","lit_element__WEBPACK_IMPORTED_MODULE_1__","templateObject_1","_closeEditor","localize","lit_html_directives_class_map__WEBPACK_IMPORTED_MODULE_2__","saved","_handleSave","_yamlChanged","firstUpdated","yamlEditor","js_yaml__WEBPACK_IMPORTED_MODULE_3___default","safeDump","config","clearHistory","_generation","changeGeneration","_resources_styles__WEBPACK_IMPORTED_MODULE_12__","templateObject_2","isClean","window","onbeforeunload","confirm","hasComments","safeLoad","err","alert","saveConfig","_a","sent","err_1","customElements","define"],"mappings":"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","file":"chunk.9b651f7288a3ca90f4fb.js","sourcesContent":["import { superstruct } from \"superstruct\";\nimport { isEntityId } from \"./is-entity-id\";\nimport { isIcon } from \"./is-icon\";\n\nexport const struct = superstruct({\n  types: {\n    \"entity-id\": isEntityId,\n    icon: isIcon,\n  },\n});\n","export function isEntityId(value: any): string | boolean {\n  if (typeof value !== \"string\") {\n    return \"entity id should be a string\";\n  }\n  if (!value.includes(\".\")) {\n    return \"entity id should be in the format 'domain.entity'\";\n  }\n  return true;\n}\n","export function isIcon(value: any): string | boolean {\n  if (typeof value !== \"string\") {\n    return \"icon should be a string\";\n  }\n  if (!value.includes(\":\")) {\n    return \"icon should be in the format 'mdi:icon'\";\n  }\n  return true;\n}\n","// @ts-ignore\nimport CodeMirror from \"codemirror\";\nimport \"codemirror/mode/yaml/yaml\";\n// @ts-ignore\nimport codeMirrorCSS from \"codemirror/lib/codemirror.css\";\nimport { HomeAssistant } from \"../../../types\";\nimport { fireEvent } from \"../../../common/dom/fire_event\";\nimport { computeRTL } from \"../../../common/util/compute_rtl\";\nimport { customElement } from \"lit-element\";\n\ndeclare global {\n  interface HASSDomEvents {\n    \"yaml-changed\": {\n      value: string;\n    };\n    \"yaml-save\": undefined;\n  }\n}\n\n@customElement(\"hui-yaml-editor\")\nexport class HuiYamlEditor extends HTMLElement {\n  public _hass?: HomeAssistant;\n\n  public codemirror!: any;\n\n  private _value: string;\n\n  public constructor() {\n    super();\n    CodeMirror.commands.save = (cm: CodeMirror) => {\n      fireEvent(cm.getWrapperElement(), \"yaml-save\");\n    };\n    this._value = \"\";\n    const shadowRoot = this.attachShadow({ mode: \"open\" });\n    shadowRoot.innerHTML = `\n            <style>\n              ${codeMirrorCSS}\n              .CodeMirror {\n                height: var(--code-mirror-height, auto);\n                direction: var(--code-mirror-direction, ltr);\n              }\n              .CodeMirror-scroll {\n                max-height: var(--code-mirror-max-height, --code-mirror-height);\n              }\n              .CodeMirror-gutters {\n                border-right: 1px solid var(--paper-input-container-color, var(--secondary-text-color));\n                background-color: var(--paper-dialog-background-color, var(--primary-background-color));\n                transition: 0.2s ease border-right;\n              }\n              .CodeMirror-focused .CodeMirror-gutters {\n                border-right: 2px solid var(--paper-input-container-focus-color, var(--primary-color));;\n              }\n              .CodeMirror-linenumber {\n                color: var(--paper-dialog-color, var(--primary-text-color));\n              }\n              .rtl .CodeMirror-vscrollbar {\n                right: auto;\n                left: 0px;\n              }\n              .rtl-gutter {\n                width: 20px;\n              }\n            </style>`;\n  }\n\n  set hass(hass: HomeAssistant) {\n    this._hass = hass;\n    if (this._hass) {\n      this.setScrollBarDirection();\n    }\n  }\n\n  set value(value: string) {\n    if (this.codemirror) {\n      if (value !== this.codemirror.getValue()) {\n        this.codemirror.setValue(value);\n      }\n    }\n    this._value = value;\n  }\n\n  get value(): string {\n    return this.codemirror.getValue();\n  }\n\n  get hasComments(): boolean {\n    return this.shadowRoot!.querySelector(\"span.cm-comment\") ? true : false;\n  }\n\n  public connectedCallback(): void {\n    if (!this.codemirror) {\n      this.codemirror = CodeMirror(\n        (this.shadowRoot as unknown) as HTMLElement,\n        {\n          value: this._value,\n          lineNumbers: true,\n          mode: \"yaml\",\n          tabSize: 2,\n          autofocus: true,\n          viewportMargin: Infinity,\n          extraKeys: {\n            Tab: \"indentMore\",\n            \"Shift-Tab\": \"indentLess\",\n          },\n          gutters:\n            this._hass && computeRTL(this._hass!)\n              ? [\"rtl-gutter\", \"CodeMirror-linenumbers\"]\n              : [],\n        }\n      );\n      this.setScrollBarDirection();\n      this.codemirror.on(\"changes\", () => this._onChange());\n    } else {\n      this.codemirror.refresh();\n    }\n  }\n\n  private _onChange(): void {\n    fireEvent(this, \"yaml-changed\", { value: this.codemirror.getValue() });\n  }\n\n  private setScrollBarDirection(): void {\n    if (!this.codemirror) {\n      return;\n    }\n\n    this.codemirror\n      .getWrapperElement()\n      .classList.toggle(\"rtl\", computeRTL(this._hass!));\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-yaml-editor\": HuiYamlEditor;\n  }\n}\n","import { LitElement, html, TemplateResult, CSSResult, css } from \"lit-element\";\nimport { classMap } from \"lit-html/directives/class-map\";\nimport yaml from \"js-yaml\";\n\nimport \"@polymer/app-layout/app-header-layout/app-header-layout\";\nimport \"@polymer/app-layout/app-header/app-header\";\nimport \"@polymer/app-layout/app-toolbar/app-toolbar\";\nimport \"@material/mwc-button\";\nimport \"@polymer/paper-icon-button/paper-icon-button\";\nimport \"@polymer/paper-spinner/paper-spinner\";\n\nimport { struct } from \"./common/structs/struct\";\nimport { Lovelace } from \"./types\";\n\nimport \"../../components/ha-icon\";\nimport { haStyle } from \"../../resources/styles\";\nimport \"./components/hui-yaml-editor\";\n// This is not a duplicate import, one is for types, one is for element.\n// tslint:disable-next-line\nimport { HuiYamlEditor } from \"./components/hui-yaml-editor\";\nimport { HomeAssistant } from \"../../types\";\n\nconst lovelaceStruct = struct.interface({\n  title: \"string?\",\n  views: [\"object\"],\n  resources: struct.optional([\"object\"]),\n});\n\nclass LovelaceFullConfigEditor extends LitElement {\n  public hass?: HomeAssistant;\n  public lovelace?: Lovelace;\n  public closeEditor?: () => void;\n  private _saving?: boolean;\n  private _changed?: boolean;\n  private _generation?: number;\n\n  static get properties() {\n    return {\n      hass: {},\n      lovelace: {},\n      closeEditor: {},\n      _saving: {},\n      _changed: {},\n    };\n  }\n\n  public render(): TemplateResult | void {\n    return html`\n      <app-header-layout>\n        <app-header>\n          <app-toolbar>\n            <paper-icon-button\n              icon=\"hass:close\"\n              @click=\"${this._closeEditor}\"\n            ></paper-icon-button>\n            <div main-title>\n              ${this.hass!.localize(\n                \"ui.panel.lovelace.editor.raw_editor.header\"\n              )}\n            </div>\n            <div\n              class=\"save-button\n              ${classMap({\n                saved: this._saving! === false || this._changed === true,\n              })}\"\n            >\n              ${this._changed\n                ? this.hass!.localize(\n                    \"ui.panel.lovelace.editor.raw_editor.unsaved_changes\"\n                  )\n                : this.hass!.localize(\n                    \"ui.panel.lovelace.editor.raw_editor.saved\"\n                  )}\n            </div>\n            <mwc-button raised @click=\"${this._handleSave}\"\n              >${this.hass!.localize(\n                \"ui.panel.lovelace.editor.raw_editor.save\"\n              )}</mwc-button\n            >\n          </app-toolbar>\n        </app-header>\n        <div class=\"content\">\n          <hui-yaml-editor\n            .hass=\"${this.hass}\"\n            @yaml-changed=\"${this._yamlChanged}\"\n            @yaml-save=\"${this._handleSave}\"\n          >\n          </hui-yaml-editor>\n        </div>\n      </app-header-layout>\n    `;\n  }\n\n  protected firstUpdated() {\n    this.yamlEditor.value = yaml.safeDump(this.lovelace!.config);\n    this.yamlEditor.codemirror.clearHistory();\n    this._generation = this.yamlEditor.codemirror.changeGeneration(true);\n  }\n\n  static get styles(): CSSResult[] {\n    return [\n      haStyle,\n      css`\n        :host {\n          --code-mirror-height: 100%;\n        }\n\n        app-header-layout {\n          height: 100vh;\n        }\n\n        app-toolbar {\n          background-color: var(--dark-background-color, #455a64);\n          color: var(--dark-text-color);\n        }\n\n        .comments {\n          font-size: 16px;\n        }\n\n        .content {\n          height: calc(100vh - 68px);\n        }\n\n        hui-code-editor {\n          height: 100%;\n        }\n\n        .save-button {\n          opacity: 0;\n          font-size: 14px;\n          padding: 0px 10px;\n        }\n\n        .saved {\n          opacity: 1;\n        }\n      `,\n    ];\n  }\n\n  private _yamlChanged() {\n    if (!this._generation) {\n      return;\n    }\n    this._changed = !this.yamlEditor.codemirror.isClean(this._generation);\n    if (this._changed && !window.onbeforeunload) {\n      window.onbeforeunload = () => {\n        return true;\n      };\n    } else if (!this._changed && window.onbeforeunload) {\n      window.onbeforeunload = null;\n    }\n  }\n\n  private _closeEditor() {\n    if (this._changed) {\n      if (\n        !confirm(\"You have unsaved changes, are you sure you want to exit?\")\n      ) {\n        return;\n      }\n    }\n    window.onbeforeunload = null;\n    if (this.closeEditor) {\n      this.closeEditor();\n    }\n  }\n\n  private async _handleSave() {\n    this._saving = true;\n\n    if (this.yamlEditor.hasComments) {\n      if (\n        !confirm(\n          \"Your config contains comment(s), these will not be saved. Do you want to continue?\"\n        )\n      ) {\n        return;\n      }\n    }\n\n    let value;\n    try {\n      value = yaml.safeLoad(this.yamlEditor.value);\n    } catch (err) {\n      alert(`Unable to parse YAML: ${err}`);\n      this._saving = false;\n      return;\n    }\n    try {\n      value = lovelaceStruct(value);\n    } catch (err) {\n      alert(`Your config is not valid: ${err}`);\n      return;\n    }\n    try {\n      await this.lovelace!.saveConfig(value);\n    } catch (err) {\n      alert(`Unable to save YAML: ${err}`);\n    }\n    this._generation = this.yamlEditor.codemirror.changeGeneration(true);\n    window.onbeforeunload = null;\n    this._saving = false;\n    this._changed = false;\n  }\n\n  private get yamlEditor(): HuiYamlEditor {\n    return this.shadowRoot!.querySelector(\"hui-yaml-editor\")!;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-editor\": LovelaceFullConfigEditor;\n  }\n}\n\ncustomElements.define(\"hui-editor\", LovelaceFullConfigEditor);\n"],"sourceRoot":""}