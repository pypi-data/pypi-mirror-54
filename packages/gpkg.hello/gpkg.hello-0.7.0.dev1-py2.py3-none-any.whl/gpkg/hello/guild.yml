# Copyright 2018-2019 TensorHub, Inc. and contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ===================================================================
# Package def
# ===================================================================

- package: gpkg.hello
  version: 0.7.0.dev1
  description: Sample "hello world" model (Guild AI)
  url: https://github.com/guildai/packages/tree/master/gpkg/hello
  author: Guild AI
  author-email: packages@guild.ai
  license: Apache 2.0
  data-files:
    - msg.txt

# ===================================================================
# Hello model
# ===================================================================

- model: hello
  description: >
    A "hello world" sample model

    This is a sample model that provides various operations for printing
    hello world messages.

    The message provided, either by default, by a flag, or a file (see
    each operation for the applicable interface) is printed to standard
    output and written to a file named `output` in the run directory.
  default: yes
  operations:
    default:
      description: >
        Print a default message

        This operation doesn not support a user-defined message. Use
        the from-flag operation with the 'message' flag to print an
        alternative message.
      main: say
      flags-import: no
    from-flag:
      description: >
        Print a message

        Use the 'message' flag to specify the message to print.
      main: say
      flags-import: no
      flags:
        message:
          description: Message to print
          default: Hello Guild, from a flag!
    from-file:
      description: >
        Print a message from a file

        Use the 'file' flag to specify the file to print.
      main: say
      requires: msg-file
      flags-import: no
      flags:
        file:
          description: File containing the message to print
          default: msg.txt
    from-file-output:
      description: >
        Print output from last file-output operation

        This operation requires a completed file-output run.
      main: say --file-output
      requires: from-file-run
      flags-import: no

  resources:
    msg-file:
      description: Default file used in from-file operation
      sources:
        - file: msg.txt
          sha256: 0bc96b4f4757a80c0a3f9b9bc14de789e5eb1d75659904de68241cfc7030e7de
    from-file-run:
      description: Output generated by from-file operation
      path: from-file
      flag-name: foo
      sources:
        - operation: hello:from-file
          select: output

# ===================================================================
# Checks
# ===================================================================

- model: _check
  operations:
    default:
      steps:
        - run: hello:default
          expect:
            - output: Hello Guild!
    from-flag:
      steps:
        - run: hello:from-flag message='test msg'
          expect:
            - output: test msg
    from-file:
      steps:
        - run: hello:from-file
          expect:
            - file: msg.txt
              compare-to: ${MODEL_DIR}/msg.txt
    from-file-output:
      steps:
        - run: hello:from-file-output
          expect:
            - file: output
              contains: Hello Guild, from a required file!
    all:
      steps:
        - default
        - from-flag
        - from-file
        - from-file-output
