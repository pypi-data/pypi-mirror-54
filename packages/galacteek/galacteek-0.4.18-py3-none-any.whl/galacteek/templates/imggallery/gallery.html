<!DOCTYPE html>
<html>
  <head>
    <title id="doctitle">Image gallery</title>
    <style type="text/css">
      body {
        background-color: white;
        font-family: Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      div#images {
        background-color: lightgrey;
        border-radius: 0.50em;
        margin: 20px;
        padding: 2em;
      }
      p {
        font-size: 16px;
        padding-bottom: 1.5em;
      }
      a:link, a:visited {
        color: #93a1a1;
        font-size: 24px;
        text-decoration: underline;
      }
      img {
        padding: 0.2em;
        border-radius: 0.25em;
      }
      h1 {
        text-align: center;
      }
    </style>
  </head>
  <body> 
    <script type="text/javascript">
      /*
       * Functions to render the DAG of the image gallery
       * generated by the galacteek UI. This is a first iteration.
       *
       */

      document.addEventListener('DOMContentLoaded', function () {
        renderGallery()
      })

      function renderGallery() {
        /* window.location parsing could be greatly improved */
        if (/^(http:\/\/.*\/ipns\/)/.test(window.location.href)) {
          var onetwo = window.location.href.split('/ipns/')
          var ipns = onetwo[1].split('/')[0]

          window.ipfs.resolve('/ipns/' + ipns, (err, res) => {
            if (err) {
              throw err
            } else {
              return renderGalleryFrom(res)
            }
          })
        }

        if (/^(http:\/\/.*\/ipfs\/)/.test(window.location.href)) {
          var onetwo = window.location.href.split('/ipfs/')
          var cid = onetwo[1].split('/')[0]

          window.ipfs.resolve('/ipfs/' + cid, (err, res) => {
            if (err) {
              throw err
            } else {
              return renderGalleryFrom(res)
            }
          })
        }

        if (window.location.protocol === 'ipfs:') {
          return renderGalleryFrom('/ipfs/' + window.location.host)
        }

        if (window.location.protocol === 'dweb:') {
          var ipath = window.location.href.replace('dweb:', '')
          var match = ipath.match(/^(\/ip(f|n)s\/\w+.*)\/(\w+.*)/)

          if (!match) {
            return
          }

          if (match.length > 3) {
            return renderGalleryFrom(match[1])
          } else {
            return renderGalleryFrom(match[0])
          }
        }
      }

      function renderGalleryFrom(rootpath) {
        window.ipfs.dag.get(rootpath + '/metadata', (err, result) => {
          if (err) {
            throw err
          }

          const node = result.value

          var title = document.getElementById('doctitle')
          title.text = node['title']
          var gtitle = document.getElementById('gtitle')
          gtitle.innerHTML = node['title']
        })

        window.ipfs.dag.get(rootpath + '/images', (err, result) => {
          if (err) {
            throw err
          }

          const node = result.value

          Object.keys(node).forEach(function(name) {
            const imgInfo = node[name]

            imga = document.createElement('a')
            img = document.createElement('img')

            if (imgInfo['thumbnail']) {
              img.setAttribute('src',
                'ipfs://' + imgInfo['thumbnail'].toString())
            } else {
              img.setAttribute('src',
                'ipfs://' + imgInfo['raw'].toString())
            }

            if (imgInfo['name']) {
              img.setAttribute('alt', imgInfo['name'])
            }

            imga.setAttribute('href', 'ipfs://' + imgInfo['raw'].toString())
            imga.appendChild(img)

            document.getElementById('images').appendChild(imga)
          })
        })
      }
    </script>

    <div id="images">
      <h1 id="gtitle"></h1>
    </div>
  </body>
</html>
