type: Workflow

name: daylight-factor

inputs:
  parameters:
    - name: worker
      description: Maximum number of workers for executing this workflow.
      value: 1   # this is the default value which can be overwritten
    - name: sensor-grid-path
      description: Relative path to sensor grid from project folder.
  artifacts:
    # This should be an artifacts since the content of the folder will be copied to
    # container for distributed runs
    - name: project-folder
      description: |
        Path to project folder for this study. This will make it easy to use relative
        path for other template inputs.
      path: '.'   # this is the default value which can be overwritten

operators:
  - name: radiance-operator
    import_from: 'radiance_operator.yaml'
  - name: honeybee-radiance
    import_from: 'honeybee_radiance_operator.json'

templates:

  - name: generate-overcast-sky
    type: function
    description: Generate an overcast sky for daylight factor simulation.
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: project-folder
          value: '.'
    command: honeybee radiance sky illuminance 100000 --folder {{inputs.parameters.project-folder}}/sky
    outputs:
      artifacts:
        - name: sky
          path: '{{inputs.parameters.project-folder}}/sky/100000_lux.sky'

  - name: split-grid
    type: function
    description: Split sensor grid into smaller grids.
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: input-grid
        - name: sensor-count
        - name: output-folder
          value: '.'   # default value
    command: |
      honeybee radiance grid split '{{inputs.parameters.input-grid}}' '{{inputs.parameters.sensor-count}}' --folder '{{inputs.parameters.output-folder}}' > '{{inputs.parameters.output-folder}}'/grids_list.txt
    outputs:
      parameters:
        - name: grid-list
          path: '{{inputs.parameters.output-folder}}/grids_list.txt'

  - name: create-octree
    type: function
    description: |
      Create an octree from a list fo input files. Files should be separated from each
      other by a space.
    operator: radiance-operator
    inputs:
      parameters:
        - name: input-files
          description: Octree input files separated by space. 
        - name: output-file
          description: Path to output octree file.
    command: oconv -f "{{inputs.parameters.input-files}}" > "{{inputs.parameters.output-file}}" 
    outputs:
      artifacts:
        - name: octree-file
          path: "{{inputs.parameters.output-file}}"

  - name: trace-rays-daylight-factor
    type: function
    operator: radiance-operator
    inputs:
      parameters:
        - name: octree-file
        - name: ray-tracing-options
          description: Radiance rtrace options for ray-tracing (e.g. -ab 3 -ad 2480)
          value: '-ab 2'
        - name: grid-file
        - name: output-file
          description: Path to output results file.
    command: |
      rtrace -I -h "{{inputs.parameters.ray-tracing-options}}" "{{inputs.parameters.octree-file}}" < "{{inputs.parameters.grid-file}}" | rcalc -e "$1=(0.265*$1+0.67*$2+0.065*$3)*179/1000" > "{{inputs.parameters.output-file}}"
    outputs:
      artifacts:
        - name: result-file
          path: '{{inputs.parameters.output-file}}'

  - name: merge-results
    type: function
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: base-name
        - name: input-folder
        - name: output-folder
    command: 'honeybee radiance grid merge {{inputs.parameters.input-folder}} {{inputs.parameters.base-name}} .res --folder {{inputs.parameters.output-folder}}'
    outputs:
      artifacts:
        - name: result-file
          path: "{{inputs.parameters.output-folder}}/{{inputs.parameters.base-name}}.res"

flow:
  name: daylight-factor
  tasks:
    - name: generate-overcast-sky
      template: generate-overcast-sky
      arguments:
        parameters:
          - name: project-folder
            value: '{{ workflow.inputs.parameters.project-folder }}'

    - name: split-grid
      template: split-grid
      arguments:
        parameters:
          - name: sensor-count
            value: "{{ workflow.inputs.parameters.sensor-count }}"
          - name: input-grid
            value: "{{ workflow.inputs.parameters.grid-name }}"
          - name: output-folder
            value: "{{ workflow.inputs.parameters.project-folder }}"
    - name: create-octree
      template: create-octree
      dependencies:
        - generate-overcast-sky
      arguments:
        - name: sky-file
          value: "{{ tasks.generate-sky.outputs.artifacts.sky }}"
        - name: scene-files
          value: "{{ workflow.inputs.parameters.scene-files }}"

    - name: trace-rays
      template: trace-rays
      dependencies:
        - create-octree
        - split-grid
      arguments:
        parameters:
          - name: grid
            value: '{{ item }}'
          - name: octree
            value: "{{ tasks.create-octree.outputs.artifacts.octree-file }}"
      loop: "{{tasks.generate-sky.outputs.parameters.split-grid}}"  # loop over the output grids

    - name: merge-results
      template: merge-results
      dependencies:
        - trace-rays
      arguments:
        parameters:
          - name: base-name
            value: "{{ workflow.inputs.parameters.grid-name }}"

# this is not supported in Argo or is it?
outputs:
  artifacts:
    - name: daylight-factor-values
      path: "{{ tasks.merge-results.outputs.artifacts.result-file }}"
